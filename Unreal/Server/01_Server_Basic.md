# 네트워크 개념

- 네트워크 구성 요소
	- Node (노드) : 네트워크 기본 단위
		- End Node, Intermediate Node
		- 기능
			- 통신 : 노드 간, 데이터 교환
			- 라우팅 : 데이터가 목적지 까지 도달하도록 최적의 경로 선택
			- 데이터 처리 : 데이터 패킷화, 패킷 분할/재조립, 오류검사
			- 네트워크 관리 : 상태 갑시, 트래픽 관리, 보안
	- Link (링크) : 노드 간 데이터를 전송하는 연결
	- Protocol (프로토콜) : 데이터의 전송 규칙

- 네트워크 배치 형태 (Topology)
	- P2P
		-  단 2대 연결
	- Bus
		- 1개의 BNC 케이블에 여러 대의 컴퓨터를 연결하는 구성
		- 전체에 Broadcasting 하면 수신 측이 자기 것만 채틱하고 나머지는 무시
	- Ring
		- 1개의 BNC 케이블을 원형으로 만든 뒤 여러 대의 컴퓨터를 연결하는 구성.
		- Bus 에 비해서 양방향 통신이 가능
	- Star
		- 중앙 Hub 또는 Switch 에 연결된 구조
	- Mesh
		- 1 : n 의 구성으로 하나의 노드가 다른 모든 노드와 연결되어 있다.
	- Tree
		- 호스트는 허브에 연결되어 있지만 모든 장치가 중앙 전송제어 장치에 연결되어 있지는 않은 형태

- 네트워크 레이어 (OSI 모델)
	- OSI 모델 : 응용 소프트웨어에서 생성한 신호가 어떻게 네트워크를 통해 다른 곳으로 전달되는지를 성의한 표준 모델. 총 7개의 Layer 로 구성.
		- L1 (물리 계층)
			- 물리적 매체 (케이블, 전기신호, 광신호 를 직접 관리)
			- 이더넷, usb, 블루투스 디바이스
		- L2 (데이터 계층)
			- 물리 계층에서 전달된 비트를 프레임으로 변환하고, 에러검사, 흐름제어, 링크 관리
			- MAC Address, MAC 프로토콜, PPP(Point-to-Point protocol)
		- L3 (네트워크 계층)
			- 데이터를 목적지 까지 옮기는 역할 (패킷 경로 결정, 패킷 주소 관리)
			- IP (Internet Protocol), IPX, 라우터
		- L4 (전송 계층)
			- 데이터 전송 관리, 흐름 제어, 오류 제어, 세그먼트 화, 연결 설정, 해제 를 담당하여 논리적 포트 사용.
			- TCP (Transmission Control Protocol), UDP (User, Datagram Protocol)
		- L5 (세션 계층)
			- 통신의 세션을 설정, 관리. 데이터 교환 동기화 와 체크 포인트 관리를 담당
			- RPC (Remote Procedure Call), NetBIOS
		- L6 (프레젠테이션 계층)
			- 데이터 형식을 변환하고 암호화 및 압축처리
			- SSL/TLS, JPEG, MPEG
		- L7 (어플리케이션 계층)
			- 네트워크 서비스에 접근하고 UI 제공 담당.
			- HTTP, FTP, SMTP, DNS

*세션(Session) : 특정 사용자와 서버 간의 상태를 유지. 플레이어와 서버 간의 연결 상태를 유지하고 관리.

- 허브 vs 스위치 차이
	- 허브는 브로드 캐스트 방식으로 받은 데이터를 연결된 모든 장치에 보낸 후, 해당 장치가 자신에게 온 데이터인지 확인
	- 스위치는 MAC Address 를 기반으로 데이터를 특정 장치( 목적지) 로만 전달한다.

- 네트워크 유형
	- PAN (Personal Area Network)
		- 개인용 네트워크 (블루투스, NFC 등)
	- LAN (Local Area Network)
		- 근거리 통신망
	- MAN (Metropolitan Area Network)
		- 도시 단위 통신망 (도시 내 공공기관 등)
	- WAN (Wide Area Network)
		- 광역 통신망 (ISP 네트워크, 다국적 기업 지사 등)
	- Internet

- Protocol
	- HTTP/HTTPS : 웹 리소스 전송
	- SMTP : 이메일
	- FTP : 파일 전송
	- TCP : 전송 계층에서 작동, 데이터를 보낸 후 수신 확인. (연결 유지)
	- UDP : 전송 계층에서 작동하며, 데이터를 보내기만 한다 (비연결)
	- IP : 네트워크 계층에서 작동하며, IP 주소를 사용해서 패킷을 옮기는 역할. 모든 인터넷의 기반 기술
![프로토콜 레이어](/Image/TIL/Protocol_Layer.png)

- MAC Address
	- 네트워크 디바이스에서 반드시 하나씩 부여된 "데이터 링크 계층" 을 위한 고유 주소체계.
	- 총 21조 개의 주소.
	- 물리적 주소.
	- 48bit 체계로 앞 부분 24bit는 IEEE 국제표준기구에서 제조사에 할당하는 '제조사 식별 부호(OUI)' 이고 뒷 부분 24bit 는 제조사에서 제품에 할당하는 '전역 주소 (UAA)'
	- MAC Address 는 일반적으로 ROM 에 탑재.

- IPv4
	- 32 비트로 나타내는 '네트워크 계층'의 데이터 전송을 위한 주소체계
	- IPv6  는 128 비트
	- IP 주소가 MAC Address 로 변환되려면, ARP(Address Resolution Protocol) 을 사용한다. 이때 내부망에 해당 IP 주소가 있는지, 외부망에 있는지 확인해야 전송이 가능.
		- 내부망에 있다면 ARP 프로토콜로 해당 IP 를 갖고 있는 디바이스로 브로드캐스팅해서 응답이 오는 디바이스에 데이터를 전송.
		- 외부망에 있다면 밖으로 나가야 하기 때문에 게이트 웨이를 찾기 위해 ARP 프로토콜을 브로드캐스팅.
	- 서브넷 마스크
		- 같은 서버넷 마스크 주소를 가지고 있다면 내부만, 다른 서브넷 마스크 주소를 갖고 있다면 외부망이다.
		- 서브넷 마스크는 NAT (Network Address Translation : 사설 IP 와 공인 IP 간의 주소를 변환하기 위한 기술) 기술로 1개의 IP 를 다른 디바이스가 나눠서 쉐어 할 수 있도록 한다.

- IP 포트
	- '전송 계층'에서 IP 주소와 함께 사용하는 특정 프로세스나 서비스를 연결하기 위한 주소체계. 대표적으로 80번 포트는 웹서비스를 뜻한다.

- 도메인 이름
	- DNS 를 통해서 도메인의 이름을 IP 주소로 변환한다.

- 암기
	- OSI 모델 (7 network layer) : 네트워크 통신을 가능케하는 표준 모델
	- Protocol : 약속된 통신 규약
	- TCP : 전송 후 데이터를 확인하는 안전성 우선 프로토콜
	- UDP : 전송 후 데이터 확인 없는 속도 우선 프로토콜 (게임에서 많이 사용)
	- Reliable UDP : 안전성과 속도를 동시에 잡기 위한 프로토콜
	- QUIC : HTTP/3 에 제안된  UDP 기반의 프로토콜
	- IP : 인터넷 기반 전송 프로토콜
	- IP Port : IP 주소와 함께 사용해서 1개의 서버에서 여러 개의 서비스를 제공할 수 있도록 해주는 역할
	- MAC Address :  네트워크 장비에 1개씩 할당된 고유 주소 (ROM 에 탑재되어 원칙적으로는 변경 불가)
	- IP 4/6 Address : 국가별, 지역별, ISP별로 할당된 주소
	- 도메인 이름 : 사람이 읽고, 쓰고, 기억하기 위한 주소 체계, DNS 를 통해서 IP 주소로 변환
	- DNS : 도메인을 IP 주소로 변환
	- DHCP : IP 주소를 여러 대의 디바이스가 공유하게 하는 서버
	- DB 서버 : 데이터 베이스로 데이터를 저장하고 읽는 서버
	- 웹 서버 : HTTP (80/443 번 포트) 서비스를 담당하는 서버
	- Restful API 서버 : JSON 기반의 데이터를 송수신하는 서버
	- API 서버 : Socket 또는 다른 프로토콜 등으로 데이터 베이스의 앞에서 게이트 역할을 하는 서버
	- 방화벽 서버 : 세션을 제어하기 위한 서버
	- 클라이언트 : 네트워크에 접속하여 다른 클라이언트와 통신하거나 서버를 사용하는 디바이스

# 온라인 게임과 네트워크 구성

- CAP 이론과 게임의 동기화
	- 분산 시스템의 동기화 '조건 3개를 모두 만족하는 시스템은 없다' 는 이론
	- Consistency (일관성)
		- 전체 시스템은 동일한 상태 값을 갖고 있어야 한다.
	- Availability (가용성)
		- 언제든지 시스템에 접근하여 값을 읽고 쓸 수 있어야 한다.
	- Partition Tolerance (분할 용인)
		- 시스템을 분할하여 병렬처리 등이 가능해야 한다.

- 게임에서 동기화
	- 게임에서 동기화는 여러 대가 묶여 있는 시스템의 상태를 동일하게 유지하는 것이다. 하지만 CAP 이론에 따라 셋 중 하나를 포기해야 한다.
	- 초기 온라인 게임
		- 일관성 유지 + 가용성 포기 -> 사용자의 입력을 서버로 보내서 일정 시간 마다 클라이언트로 브로드캐스팅한다.
		- 순서
			- 클라이언트 : 서버 접속
			- 서버 : 모든 클라이언트 게임 접속 후 게임 시작 (상태 초기화)
			- 클라이언트 A, B : 이벤트 발생
			- 서버 : 이벤트 수집 후, 정해진 시간 마다 브로드 캐스팅
			- 클라이언트 A, B 업데이트
	- 후기 온라인 게임
		- 기본적인 캐릭터의 이동 등은 시간을 짧게 해서 브로드 캐스팅하고, 실시간으로 별도의 채널을 통해 다중 브로드 캐스팅.

- 가용성 보정 (가용성 을 포기하고 일관성을 우선시 하는 CP 설계의 경우)
	- 포인트 클릭으로 이동하는 경우 순서는
		- 마우스 클릭
		- 게이머에게 피드백하면서, 서버에 이벤트 전송
		- 서버가 브로드캐스팅한 데이터로 클라이언트가 상태를 업데이트
	- 이때 플레이어가 입력한 이벤트 시간과 서버에서 오는 데이터를 수신하는 시간의 차이가 발생한다. 
	- 따라서 클라이 언트 업데이트 이전에 플레이어가 클릭하면 사운드나 이펙트를 호출하여 기다리는 시간이 없는것처럼 위장.
- 일관성 보정 (일솬성을 포기하고 가용성을 우선시하는 AP 설계의 경우)
	- 게임 클라이언트를 우선 업데이트 하고, 후에 일관성을 보정.
	- 예측과 서버 값이 맞으면 그대로 진행하고 예측과 서버 값이 틀리면 서버 값으로 반영한다.
	- 특정 플레이어가 Latency 가 떨어지더라도 세션을 그대로 유지한다.
- 클라이언트 보간
	- 네트워크는 일정한 주기를 유지하지 않는다. 따라서 각 주기를 계산하여 일정한 주기라면 어떤 값이 적용해야 할지 보간한다.
	- 순서
		- 서버 데이터 수신
			- 서버는 일정 간격으로 캐릭터의 위치를 클라이언트에 전송
		- 클라이언트 버퍼링
			- 클라이언트는 수신된 위치값을 바로 렌더링 하지 않고, 약간의 지연를 두고 버퍼에 저장.
		- 보간 계산
			- 클라이언트는 시간 비율에 따라 버퍼에 저장한 데이터를 보간 계산
		- 렌더링
			- 매 프레임 마다 보간 된 위치를 화면에 반영

- 온라인 게임 네트워크 구성 진화
	1. 각 pc -> 서버 -> DB
	2. 각 pc -> 로그인 서버, 게임 서버 -> DB
	3. 각 pc -> 로그인 서버, 게임 서버, 채팅 서버 -> DB
	4. 각 pc -> 로그인 서버, 게임 서버, 채팅 서버, CDN(패치서버) -> DB
	5. 각 pc -> L4/L7 스위치 -> 각 서버(각 서버 별로 여러 서버를 가진다.) -> DB
	6. 각 PC -> 방화벽 -> L4/L7 스위치 -> 각 서버(각 서버 별로 여러 서버를 가진다.) -> DB Cluster
	7. 각 PC -> 방화벽 -> L4/L7 스위치 -> 각 서버(각 서버 별로 여러 서버를 가진다.) -> Redis Cluster -> DB Cluster
	8. 각 PC -> 방화벽 -> L4/L7 스위치 -> 각 서버(각 서버 별로 여러 서버를 가진다.; 스위치와 로그인 서버 사이에 Cache) -> Redis Cluster -> DB Cluster
	9. 각 PC -> 방화벽 -> L4/L7 스위치 -> 각 서버(각 서버 별로 여러 서버를 가진다.; 스위치와 로그인 서버 사이에 Cache)
		-> Redis Cluster -> DB Cluster
		->Message Queue(각 서버 끼리의 메시지 송수신)